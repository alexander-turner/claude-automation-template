name: Conflict Resolution Suggestions

# Generates suggestions for resolving template sync conflicts.
# Can be triggered manually or via PR comment.

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to analyze (leave empty for latest template-sync PR)"
        required: false
        type: string
  issue_comment:
    types: [created]

env:
  TEMPLATE_REPO: "alexander-turner/claude-automation-template"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check if should run
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // For workflow_dispatch, always run
            if (context.eventName === 'workflow_dispatch') {
              let prNumber = '${{ inputs.pr_number }}' || '';

              if (!prNumber) {
                // Find the latest template-sync PR
                const prs = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  head: `${context.repo.owner}:template-sync`
                });

                if (prs.data.length > 0) {
                  prNumber = prs.data[0].number;
                } else {
                  core.setOutput('should_run', 'false');
                  console.log('No open template-sync PR found');
                  return;
                }
              }

              core.setOutput('should_run', 'true');
              core.setOutput('pr_number', prNumber);
              return;
            }

            // For issue_comment, check if it's a PR comment with the trigger phrase
            if (context.eventName === 'issue_comment') {
              const comment = context.payload.comment.body.toLowerCase();
              const isPR = !!context.payload.issue.pull_request;

              // Check for trigger phrases
              const triggers = [
                '@claude help resolve conflicts',
                '@claude resolve conflicts',
                '@claude help with conflicts',
                '/claude-resolve'
              ];

              const triggered = triggers.some(t => comment.includes(t));

              if (isPR && triggered) {
                // Check if commenter has write access to prevent spam on public repos
                const permission = await github.rest.repos.getCollaboratorPermissionLevel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  username: context.payload.comment.user.login
                });
                if (!['admin', 'write', 'maintain'].includes(permission.data.permission)) {
                  console.log(`User ${context.payload.comment.user.login} does not have write permission, skipping`);
                  core.setOutput('should_run', 'false');
                  return;
                }

                core.setOutput('should_run', 'true');
                core.setOutput('pr_number', context.payload.issue.number);
                return;
              }
            }

            core.setOutput('should_run', 'false');

  resolve-conflicts:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR information
        id: pr-info
        env:
          PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);

            if (!prNumber || isNaN(prNumber)) {
              core.setFailed('Invalid PR number');
              return;
            }

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Get PR body for conflict information
            const body = pr.data.body || '';

            core.setOutput('pr_title', pr.data.title);
            core.setOutput('pr_body', body);
            core.setOutput('pr_branch', pr.data.head.ref);
            core.setOutput('base_branch', pr.data.base.ref);

      - name: Checkout PR branch
        run: |
          git fetch origin ${{ steps.pr-info.outputs.pr_branch }}
          git checkout ${{ steps.pr-info.outputs.pr_branch }}

      - name: Fetch template for comparison
        run: |
          git clone --depth 1 "https://github.com/${{ env.TEMPLATE_REPO }}.git" _template_ref || echo "::warning::Could not clone template repo - template comparisons will be unavailable"

      - name: Generate conflict resolution suggestions
        id: suggestions
        env:
          PR_BODY: ${{ steps.pr-info.outputs.pr_body }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Use environment variable to avoid template string injection
            const prBody = process.env.PR_BODY || '';

            // Parse conflict information from PR body
            // Fixed regex: use $ instead of invalid \Z
            const conflictSection = prBody.match(/## âš ï¸ (Manual Merge Required|Conflicts Detected)[\s\S]*?(?=---(?:\s|$)|$)/);

            if (!conflictSection) {
              core.setOutput('has_conflicts', 'false');
              core.setOutput('suggestions', 'No conflicts detected in this PR.');
              return;
            }

            // Extract conflicting files
            const fileMatches = prBody.match(/### `([^`]+)`/g) || [];
            const conflictFiles = fileMatches.map(m => m.replace(/### `|`/g, ''));

            if (conflictFiles.length === 0) {
              core.setOutput('has_conflicts', 'false');
              core.setOutput('suggestions', 'No specific conflict files identified.');
              return;
            }

            core.setOutput('has_conflicts', 'true');
            core.setOutput('conflict_files', conflictFiles.join(','));

            // Generate suggestions based on file types
            let suggestions = `## ðŸ”§ Conflict Resolution Suggestions\n\n`;
            suggestions += `I've analyzed the files that differ between your repository and the template. Here are my suggestions:\n\n`;

            for (const file of conflictFiles) {
              suggestions += `### \`${file}\`\n\n`;

              // Read current file content if it exists
              let localContent = '';
              let templateContent = '';

              try {
                localContent = fs.readFileSync(file, 'utf8');
              } catch (e) {
                localContent = '(file not found locally)';
              }

              try {
                templateContent = fs.readFileSync(path.join('_template_ref', file), 'utf8');
              } catch (e) {
                templateContent = '(file not found in template)';
              }

              // Analyze the type of file and provide specific guidance
              if (file.endsWith('.md')) {
                suggestions += `**Analysis:** This is a documentation/configuration file that likely contains project-specific customizations.\n\n`;
                suggestions += `**Recommendation:** Merge both versions - keep your project-specific content while incorporating any new sections from the template.\n\n`;
              } else if (file.endsWith('.json')) {
                suggestions += `**Analysis:** This is a configuration file.\n\n`;
                suggestions += `**Recommendation:** Review each setting individually. Keep project-specific settings while updating shared infrastructure settings from the template.\n\n`;
              } else if (file.endsWith('.sh')) {
                suggestions += `**Analysis:** This is a shell script.\n\n`;
                suggestions += `**Recommendation:** Check for any project-specific commands or paths. The template version likely has improvements that should be adopted.\n\n`;
              } else if (file.endsWith('.yaml') || file.endsWith('.yml')) {
                suggestions += `**Analysis:** This is a workflow/configuration file.\n\n`;
                suggestions += `**Recommendation:** Carefully merge - template updates may include important fixes or new features, but preserve any project-specific customizations.\n\n`;
              } else {
                suggestions += `**Recommendation:** Compare both versions and merge as appropriate.\n\n`;
              }

              suggestions += `---\n\n`;
            }

            suggestions += `### General Guidance\n\n`;
            suggestions += `1. **Review each difference** - Don't blindly accept either version\n`;
            suggestions += `2. **Preserve customizations** - Your project-specific content should be kept\n`;
            suggestions += `3. **Adopt improvements** - Template updates often include bug fixes and enhancements\n`;
            suggestions += `4. **Test after merging** - Ensure everything still works after resolving conflicts\n\n`;
            suggestions += `To apply changes:\n`;
            suggestions += `- Edit the files directly on the PR branch\n`;
            suggestions += `- Or merge manually in your local environment\n`;

            core.setOutput('suggestions', suggestions);

      - name: Post suggestions to PR
        if: steps.suggestions.outputs.has_conflicts == 'true'
        env:
          PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
          SUGGESTIONS: ${{ steps.suggestions.outputs.suggestions }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            const suggestions = process.env.SUGGESTIONS || '';

            // Hidden marker to identify our comments (avoids false matches from quoted text)
            const marker = '<!-- conflict-resolution-suggestions-marker -->';

            // Check if we already posted suggestions
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existingComment = comments.data.find(c => c.body?.includes(marker));

            const body = marker + '\n' + suggestions + `\n\n---\n*Generated by Conflict Resolution workflow*`;

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
              console.log('Updated existing suggestions comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log('Posted new suggestions comment');
            }

      - name: Post no-conflicts message
        if: steps.suggestions.outputs.has_conflicts == 'false'
        env:
          PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## âœ… No Conflicts Detected\n\nThis template sync PR doesn't appear to have any conflicts with local customizations. It should be safe to merge.\n\n---\n*Generated by Conflict Resolution workflow*`
            });
