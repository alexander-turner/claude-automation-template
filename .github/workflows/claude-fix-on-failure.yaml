name: Claude Auto-Fix

# Automatically fixes CI failures using Claude API when triggered by failure comments

on:
  issue_comment:
    types: [created, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  claude-fix:
    # Only run on PR comments from github-actions that contain our trigger marker
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'github-actions[bot]' &&
      contains(github.event.comment.body, '<!-- claude-failure-tracker -->')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            // Only process PRs from claude/ branches
            if (!pr.data.head.ref.startsWith('claude/')) {
              core.setOutput('should_process', 'false');
              return;
            }

            core.setOutput('should_process', 'true');
            core.setOutput('branch', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);
            return pr.data;

      - name: Checkout PR branch
        if: steps.pr.outputs.should_process == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.branch }}
          fetch-depth: 0

      - name: Setup base environment
        if: steps.pr.outputs.should_process == 'true'
        uses: ./.github/actions/setup-base-env

      - name: Parse failure details
        if: steps.pr.outputs.should_process == 'true'
        id: failures
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;

            // Extract workflow names and URLs from the comment
            const failurePattern = /\*\*(.+?)\*\* \[failed\]\((.+?)\)/g;
            const failures = [];
            let match;

            while ((match = failurePattern.exec(comment)) !== null) {
              failures.push({
                workflow: match[1],
                url: match[2]
              });
            }

            core.setOutput('workflows', JSON.stringify(failures));
            console.log('Found failures:', failures);

      - name: Get failure logs
        if: steps.pr.outputs.should_process == 'true'
        id: logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract run IDs and fetch logs
          FAILURES='${{ steps.failures.outputs.workflows }}'
          LOGS=""

          for url in $(echo "$FAILURES" | jq -r '.[].url'); do
            RUN_ID=$(echo "$url" | grep -oE '[0-9]+$')
            if [ -n "$RUN_ID" ]; then
              echo "Fetching logs for run $RUN_ID..."
              # Get failed job logs
              JOB_LOGS=$(gh run view "$RUN_ID" --log-failed 2>&1 | tail -100 || echo "Could not fetch logs")
              LOGS="${LOGS}\n\n=== Run $RUN_ID ===\n${JOB_LOGS}"
            fi
          done

          # Save to file to avoid escaping issues
          echo -e "$LOGS" > /tmp/failure_logs.txt

      - name: Analyze and fix with Claude
        if: steps.pr.outputs.should_process == 'true'
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Gather context
          FAILURE_LOGS=$(cat /tmp/failure_logs.txt)
          FAILURES='${{ steps.failures.outputs.workflows }}'

          # Build the prompt
          cat > /tmp/prompt.json << 'PROMPT_EOF'
          {
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 4096,
            "messages": [
              {
                "role": "user",
                "content": "You are a code fixing assistant. Analyze the CI failure and provide exact fixes.\n\nFailed workflows: FAILURES_PLACEHOLDER\n\nFailure logs:\n```\nLOGS_PLACEHOLDER\n```\n\nRepository files that might need fixing:\nFILES_PLACEHOLDER\n\nProvide your response in this exact JSON format:\n{\n  \"analysis\": \"brief explanation of the issue\",\n  \"fixes\": [\n    {\n      \"file\": \"path/to/file\",\n      \"action\": \"edit|create|delete\",\n      \"content\": \"full new content for the file (for edit/create)\",\n      \"reason\": \"why this fix is needed\"\n    }\n  ],\n  \"commands\": [\"optional shell commands to run, like pnpm format\"]\n}\n\nOnly include fixes that directly address the CI failure. Be precise and minimal."
              }
            ]
          }
          PROMPT_EOF

          # Get relevant file list
          FILES=$(find . -type f \( -name "*.ts" -o -name "*.js" -o -name "*.json" -o -name "*.yaml" -o -name "*.yml" \) \
            -not -path "./node_modules/*" -not -path "./.git/*" | head -50)

          # Read key files that often cause format/lint issues
          FILE_CONTENTS=""
          for f in package.json tsconfig.json .prettierrc .eslintrc* src/*.ts src/*.js 2>/dev/null; do
            if [ -f "$f" ]; then
              FILE_CONTENTS="${FILE_CONTENTS}\n\n=== $f ===\n$(cat "$f" | head -100)"
            fi
          done

          # Substitute placeholders
          PROMPT=$(cat /tmp/prompt.json)
          PROMPT=$(echo "$PROMPT" | sed "s|FAILURES_PLACEHOLDER|$FAILURES|g")
          PROMPT=$(echo "$PROMPT" | sed "s|LOGS_PLACEHOLDER|$(echo "$FAILURE_LOGS" | head -50 | sed 's/"/\\"/g' | tr '\n' ' ')|g")
          PROMPT=$(echo "$PROMPT" | sed "s|FILES_PLACEHOLDER|$(echo "$FILE_CONTENTS" | sed 's/"/\\"/g' | tr '\n' ' ')|g")

          echo "$PROMPT" > /tmp/request.json

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @/tmp/request.json)

          echo "$RESPONSE" > /tmp/claude_response.json

          # Extract the text content
          CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [ -z "$CONTENT" ]; then
            echo "Error: No response from Claude"
            echo "$RESPONSE"
            exit 1
          fi

          # Extract JSON from response (handle markdown code blocks)
          echo "$CONTENT" | sed -n '/^{/,/^}/p' > /tmp/fixes.json || echo "$CONTENT" > /tmp/fixes.json

      - name: Apply fixes
        if: steps.pr.outputs.should_process == 'true'
        id: apply
        run: |
          FIXES=$(cat /tmp/fixes.json)

          # Check if we got valid JSON
          if ! echo "$FIXES" | jq . > /dev/null 2>&1; then
            echo "Could not parse Claude's response as JSON"
            echo "Raw response:"
            cat /tmp/fixes.json
            echo "applied=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          ANALYSIS=$(echo "$FIXES" | jq -r '.analysis // "No analysis provided"')
          echo "Analysis: $ANALYSIS"

          # Apply file fixes
          FIXED=false
          echo "$FIXES" | jq -c '.fixes[]?' | while read -r fix; do
            FILE=$(echo "$fix" | jq -r '.file')
            ACTION=$(echo "$fix" | jq -r '.action')
            CONTENT=$(echo "$fix" | jq -r '.content')
            REASON=$(echo "$fix" | jq -r '.reason')

            echo "Applying fix to $FILE ($ACTION): $REASON"

            case "$ACTION" in
              edit|create)
                mkdir -p "$(dirname "$FILE")"
                echo "$CONTENT" > "$FILE"
                FIXED=true
                ;;
              delete)
                rm -f "$FILE"
                FIXED=true
                ;;
            esac
          done

          # Run any suggested commands
          echo "$FIXES" | jq -r '.commands[]?' | while read -r cmd; do
            if [ -n "$cmd" ] && [ "$cmd" != "null" ]; then
              echo "Running: $cmd"
              eval "$cmd" || true
            fi
          done

          # Check if there are changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
            echo "applied=false" >> $GITHUB_OUTPUT
          else
            echo "applied=true" >> $GITHUB_OUTPUT
            echo "$ANALYSIS" > /tmp/analysis.txt
          fi

      - name: Commit and push fixes
        if: steps.pr.outputs.should_process == 'true' && steps.apply.outputs.applied == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          ANALYSIS=$(cat /tmp/analysis.txt 2>/dev/null || echo "Fix CI failures")

          git add -A
          git commit -m "fix: auto-fix CI failures

          $ANALYSIS

          Co-authored-by: Claude <claude@anthropic.com>"

          git push origin ${{ steps.pr.outputs.branch }}

      - name: Comment on PR
        if: steps.pr.outputs.should_process == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let analysis = "Analyzed the failure";
            try {
              analysis = fs.readFileSync('/tmp/analysis.txt', 'utf8');
            } catch (e) {}

            const applied = '${{ steps.apply.outputs.applied }}' === 'true';

            let body;
            if (applied) {
              body = `ðŸ¤– **Claude Auto-Fix Applied**\n\n${analysis}\n\nI've pushed a commit with the fix. The CI should re-run automatically.`;
            } else {
              body = `ðŸ¤– **Claude Analysis**\n\n${analysis}\n\nI couldn't automatically apply a fix. Manual intervention may be needed.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
