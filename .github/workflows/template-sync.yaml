name: Sync from Template

# Syncs updates from the template repository automatically.
# Runs daily or manually via "Run workflow" button.
# No setup required - works out of the box.
#
# When conflicts are detected (local customizations vs template updates),
# the PR will include detailed conflict information for Claude to help resolve.

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Show what would be synced without making changes"
        required: false
        default: "false"
        type: boolean
  schedule:
    # Run daily at 9am UTC
    - cron: "0 9 * * *"

env:
  TEMPLATE_REPO: "alexander-turner/claude-automation-template"
  # Only sync core automation files that don't need customization
  SYNC_PATHS: ".claude .hooks .github/workflows/template-sync.yaml .github/workflows/dependabot-auto-merge.yaml .github/workflows/claude-conflict-resolution.yaml"
  # These are excluded because they require project-specific customization
  # (comment-on-failed-checks needs workflow names, lint/test need project scripts)
  EXCLUDE_PATHS: ""

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout child repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout template repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TEMPLATE_REPO }}
          path: _template
          token: ${{ secrets.TEMPLATE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Sync template files with conflict detection
        id: sync
        run: |
          set -e
          changes=""
          conflicts=""
          conflict_details=""

          # File to store conflict information for the PR body
          echo "" > /tmp/conflict_report.md

          for path in $SYNC_PATHS; do
            # Skip if in exclude list
            skip=false
            for exclude in $EXCLUDE_PATHS; do
              if [ "$path" = "$exclude" ]; then
                skip=true
                break
              fi
            done
            [ "$skip" = "true" ] && continue

            # Check if path exists in template
            if [ ! -e "_template/$path" ]; then
              echo "Warning: $path not found in template, skipping"
              continue
            fi

            # Handle directories by processing files individually
            if [ -d "_template/$path" ]; then
              find "_template/$path" -type f | while read template_file; do
                rel_path="${template_file#_template/}"

                # Create parent directory if needed
                parent_dir=$(dirname "$rel_path")
                [ "$parent_dir" != "." ] && mkdir -p "$parent_dir"

                if [ -f "$rel_path" ]; then
                  # File exists locally - check for conflicts
                  if ! diff -q "$rel_path" "$template_file" > /dev/null 2>&1; then
                    # Files differ - check if local file was customized from original template
                    # Get the original template version from git history if possible
                    original_in_git=$(git show HEAD:"$rel_path" 2>/dev/null || echo "")

                    if [ -n "$original_in_git" ] && ! diff -q "$rel_path" <(echo "$original_in_git") > /dev/null 2>&1; then
                      # Local file has been modified from what's in git - potential conflict
                      echo "CONFLICT: $rel_path (local customizations exist)"
                      echo "$rel_path" >> /tmp/conflict_files.txt

                      # Generate conflict report
                      {
                        echo "### \`$rel_path\`"
                        echo ""
                        echo "<details>"
                        echo "<summary>View conflict details</summary>"
                        echo ""
                        echo "**Current local version:**"
                        echo "\`\`\`"
                        head -100 "$rel_path"
                        echo "\`\`\`"
                        echo ""
                        echo "**Template version:**"
                        echo "\`\`\`"
                        head -100 "$template_file"
                        echo "\`\`\`"
                        echo ""
                        echo "**Diff (local → template):**"
                        echo "\`\`\`diff"
                        diff -u "$rel_path" "$template_file" | head -50 || true
                        echo "\`\`\`"
                        echo "</details>"
                        echo ""
                      } >> /tmp/conflict_report.md

                      # Still copy the template version but mark as conflict
                      cp "$template_file" "$rel_path"
                    else
                      # No local customizations, safe to update
                      cp "$template_file" "$rel_path"
                    fi
                  fi
                else
                  # New file from template
                  cp "$template_file" "$rel_path"
                fi
              done
            else
              # Single file
              parent_dir=$(dirname "$path")
              [ "$parent_dir" != "." ] && mkdir -p "$parent_dir"

              if [ -f "$path" ]; then
                # File exists locally - check for conflicts
                if ! diff -q "$path" "_template/$path" > /dev/null 2>&1; then
                  # Check if local has customizations
                  original_in_git=$(git show HEAD:"$path" 2>/dev/null || echo "")

                  if [ -n "$original_in_git" ]; then
                    # Compare current local with git version to detect customizations
                    if ! echo "$original_in_git" | diff -q "$path" - > /dev/null 2>&1; then
                      echo "CONFLICT: $path (local customizations exist)"
                      echo "$path" >> /tmp/conflict_files.txt

                      {
                        echo "### \`$path\`"
                        echo ""
                        echo "<details>"
                        echo "<summary>View conflict details</summary>"
                        echo ""
                        echo "**Current local version:**"
                        echo "\`\`\`"
                        head -100 "$path"
                        echo "\`\`\`"
                        echo ""
                        echo "**Template version:**"
                        echo "\`\`\`"
                        head -100 "_template/$path"
                        echo "\`\`\`"
                        echo ""
                        echo "**Diff (local → template):**"
                        echo "\`\`\`diff"
                        diff -u "$path" "_template/$path" | head -50 || true
                        echo "\`\`\`"
                        echo "</details>"
                        echo ""
                      } >> /tmp/conflict_report.md
                    fi
                  fi

                  cp "_template/$path" "$path"
                fi
              else
                cp "_template/$path" "$path"
              fi
            fi
          done

          # Check for conflicts
          if [ -f /tmp/conflict_files.txt ] && [ -s /tmp/conflict_files.txt ]; then
            conflicts=$(cat /tmp/conflict_files.txt | tr '\n' ' ')
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "conflict_files=$conflicts" >> $GITHUB_OUTPUT

            # Store conflict report for PR body
            conflict_report=$(cat /tmp/conflict_report.md)
            echo "conflict_report<<EOF" >> $GITHUB_OUTPUT
            echo "$conflict_report" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          fi

          # Clean up template
          rm -rf _template

          # Check for any changes
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            changed=$(git diff --name-only | tr '\n' ' ')
            echo "changed_paths=$changed" >> $GITHUB_OUTPUT
          fi

      - name: Show diff (dry run)
        if: inputs.dry-run == 'true' && steps.sync.outputs.has_changes == 'true'
        run: |
          echo "=== Changes that would be made ==="
          git diff
          if [ "${{ steps.sync.outputs.has_conflicts }}" = "true" ]; then
            echo ""
            echo "=== CONFLICTS DETECTED ==="
            echo "The following files have local customizations that would be overwritten:"
            echo "${{ steps.sync.outputs.conflict_files }}"
          fi

      - name: Create Pull Request
        if: inputs.dry-run != 'true' && steps.sync.outputs.has_changes == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.TEMPLATE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync from template repository"
          title: "chore: sync from template repository"
          body: |
            This PR syncs updates from the template repository.

            **Updated paths:** ${{ steps.sync.outputs.changed_paths }}

            **Template repository:** ${{ env.TEMPLATE_REPO }}

            ${{ steps.sync.outputs.has_conflicts == 'true' && '---

            ## ⚠️ Conflicts Detected

            The following files have local customizations that may be overwritten by this sync. **Please review carefully before merging.**

            To get Claude'\''s help resolving these conflicts:
            1. Comment `@claude help resolve conflicts` on this PR, or
            2. Run the "Claude Conflict Resolution" workflow from the Actions tab

            ### Conflicting Files

            ' || '' }}${{ steps.sync.outputs.conflict_report }}

            ---
            Please review the changes and merge if appropriate.
          branch: template-sync
          delete-branch: true
          labels: ${{ steps.sync.outputs.has_conflicts == 'true' && 'template-sync,needs-conflict-resolution' || 'template-sync' }}
