name: Comment on Failed Checks

# This workflow comments on PRs from claude/ branches when CI checks fail,
# helping Claude Code identify and fix issues automatically.

on:
  workflow_run:
    workflows:
      # Add your workflow names here
      - "Node tests"
      - "Lint"
      # - "Python tests"
      # - "Type check"
    types:
      - completed

permissions:
  pull-requests: write
  actions: read

concurrency:
  group: comment-on-failure-${{ github.event.workflow_run.pull_requests[0].number }}

jobs:
  comment-on-failure:
    # Only run if the workflow failed and was triggered by a PR from a claude/ branch
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.pull_requests[0] != null &&
      startsWith(github.event.workflow_run.head_branch, 'claude/')
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.workflow_run.pull_requests[0].number;
            const workflowName = context.payload.workflow_run.name;
            const runUrl = context.payload.workflow_run.html_url;
            const runId = context.payload.workflow_run.id;
            const headSha = context.payload.workflow_run.head_sha.substring(0, 7);

            const trackerMarker = '<!-- claude-failure-tracker -->';
            const maxAttempts = 2; // Stop pinging after 2 failures per workflow

            try {
              // Find existing tracker comment
              const comments = await github.paginate(github.rest.issues.listComments, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              const trackerComment = comments.find(c => c.body?.includes(trackerMarker));

              // Parse existing failures from tracker comment
              let failures = {};
              if (trackerComment) {
                const match = trackerComment.body.match(/<!-- failures:(\{.*?\}) -->/);
                if (match) {
                  try {
                    failures = JSON.parse(match[1]);
                  } catch (e) {
                    console.log('Failed to parse failures JSON, starting fresh');
                  }
                }
              }

              // Check if we already tracked this specific run
              if (failures[workflowName]?.some(f => f.run === runId)) {
                console.log(`Already tracked run ${runId} for ${workflowName}, skipping`);
                return;
              }

              // Check if workflow has exceeded max attempts
              const workflowAttempts = failures[workflowName]?.length || 0;
              if (workflowAttempts >= maxAttempts) {
                console.log(`${workflowName} has ${workflowAttempts} failures (max: ${maxAttempts}), skipping`);
                return;
              }

              // Add new failure
              if (!failures[workflowName]) {
                failures[workflowName] = [];
              }
              failures[workflowName].push({ run: runId, sha: headSha, url: runUrl });

              // Build comment body
              const failureLines = Object.entries(failures).map(([name, runs]) => {
                const latest = runs[runs.length - 1];
                return `- **${name}** [failed](${latest.url}) on commit ${latest.sha} (attempt ${runs.length}/${maxAttempts})`;
              }).join('\n');

              const body = `${trackerMarker}
            <!-- failures:${JSON.stringify(failures)} -->
            @claude The following workflows have failed:

            ${failureLines}

            Please investigate and fix the issues.`;

              if (trackerComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: trackerComment.id,
                  body: body,
                });
                console.log(`Updated tracker comment for ${workflowName} failure`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: body,
                });
                console.log(`Created tracker comment for ${workflowName} failure`);
              }
            } catch (error) {
              core.setFailed(`Failed to comment on PR: ${error.message}`);
            }
